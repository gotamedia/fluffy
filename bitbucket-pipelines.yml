image: atlassian/default-image:3

pipelines:
  branches:
    trunk:
      - step:
          name: Build and Test
          script:
            - npm i
            - npm test
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: Publish
          deployment: production
          script:
            - npm i -g standard-version
            - npm run release
            - git push --follow-tags origin trunk
            - pipe: atlassian/npm-publish:0.2.0
              variables:
                NPM_TOKEN: $NPM_TOKEN
  custom:
      Storybook:
        - step:
            name: Build
            script:
              - npm i
              - npm run build-storybook
            artifacts:
              - storybook-static/**
        - step:
            name: Deploy
            deployment: production
            script:
              - npm i
              - npm run build-storybook
              - pipe: atlassian/aws-s3-deploy:0.3.8
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                  AWS_DEFAULT_REGION: $AWS_REGION
                  S3_BUCKET: $AWS_BUCKET_NAME
                  LOCAL_PATH: 'storybook-static'
                  ACL: 'public-read'