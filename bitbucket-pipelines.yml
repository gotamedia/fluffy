image: atlassian/default-image:3

pipelines:
  branches:
    trunk:
      - step:
          name: Build and Test
          caches:
            - node
          script:
            - npm i
            - npm test
            - npm run build
          artifacts:
            - dist/**
      - step:
          name: Publish
          deployment: production
          script:
            - npm i -g standard-version
            - npm run release
            - git push --follow-tags origin trunk
            - pipe: atlassian/npm-publish:0.2.0
              variables:
                NPM_TOKEN: ${NPM_TOKEN}
  custom:
      Storybook:
        - step:
            name: Build
            caches:
              - node
            script:
              - npm i
              - npm run build-storybook
            artifacts:
              - storybook-static/**
        - step:
            name: Deploy
            deployment: production
            image:
              name: gotamedia/aws-cli:latest
              run-as-user: 1000
            script:
              - >
                aws cloudformation deploy \
                    --template-file "aws/template.yml" \
                    --stack-name "${BITBUCKET_REPO_SLUG,,}" \
                    --capabilities CAPABILITY_IAM \
                    --parameter-overrides \
                      CertificateARN "${CERTIFICATE_ARN}" \
                      DomainName "${DOMAIN_NAME}"
#- aws s3 sync
#- aws cloudfront create invalidation
